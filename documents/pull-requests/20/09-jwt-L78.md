---
file: workers/tools/sources/jwt.ts
---
_âš ï¸ Potential issue_ | _ğŸŸ  Major_

**`verifyJWT`ì—ì„œ í•„ìˆ˜ í´ë ˆì„(`sub`, `iat`, `exp`) ìœ íš¨ì„± ê²€ì¦ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.**

Line 74ì˜ `as JWTPayload` ìºìŠ¤íŠ¸ëŠ” ëŸ°íƒ€ì„ íƒ€ì… ì•ˆì „ì„±ì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìœ íš¨í•œ ì„œëª…ì„ ê°€ì§„ í† í°ì´ `sub` ì—†ì´ ë°œí–‰ë  ê²½ìš°, `payload.sub`ê°€ `undefined`ë¡œ ë°˜í™˜ë˜ì–´ `workers/crawler-manager-worker/sources/index.ts`ì˜ Line 313ì—ì„œ `userUUID`ê°€ `undefined`ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤. ì´ëŠ” ì¸ê°€ ìš°íšŒë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.


<details>
<summary>ğŸ›¡ï¸ í´ë ˆì„ ìœ íš¨ì„± ê²€ì¦ ì¶”ê°€ ì œì•ˆ</summary>

```diff
     const decodedBody = new TextDecoder().decode(base64URLDecode(body));
     const payload = JSON.parse(decodedBody) as JWTPayload;

+    if (typeof payload.sub !== 'string' || typeof payload.iat !== 'number' || typeof payload.exp !== 'number') {
+      return null;
+    }
+
     if (typeof payload.exp === 'number' && payload.exp < Math.floor(Date.now() / 1000)) {
       return null;
     }
```
</details>

<details>
<summary>ğŸ¤– Prompt for AI Agents</summary>

```
Verify each finding against the current code and only fix it if needed.

In `@workers/tools/sources/jwt.ts` around lines 73 - 78, In verifyJWT, the code
currently casts the parsed JSON to JWTPayload and only checks exp; add runtime
validation for required claims instead: after parsing decodedBody into payload
(the variable parsed from JSON), verify that payload.sub is a non-empty string
and that payload.iat and payload.exp are numbers (and payload.exp >= payload.iat
and payload.exp is in the future); if any check fails return null (or the
existing failure path). Remove reliance on the TypeScript cast and perform
explicit type checks on payload.sub, payload.iat, and payload.exp to prevent
undefined userUUID propagation.
```

</details>

<!-- fingerprinting:phantom:medusa:phoenix -->

<!-- This is an auto-generated comment by CodeRabbit -->
