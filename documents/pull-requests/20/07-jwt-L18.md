---
file: workers/tools/sources/jwt.ts
---
_âš ï¸ Potential issue_ | _ğŸŸ¡ Minor_

**`btoa()`ëŠ” Latin-1 ë²”ìœ„ ì™¸ì˜ ë¬¸ìì—ì„œ ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤.**

`btoa()`ëŠ” ì½”ë“œ í¬ì¸íŠ¸ê°€ 255ë¥¼ ì´ˆê³¼í•˜ëŠ” ë¬¸ìì—´ì— ëŒ€í•´ `InvalidCharacterError`ë¥¼ throwí•©ë‹ˆë‹¤. `signJWT`ì˜ í˜ì´ë¡œë“œì— ë¹„ASCII ë¬¸ìê°€ í¬í•¨ëœ ì»¤ìŠ¤í…€ í´ë ˆì„(ì˜ˆ: ìœ ë‹ˆì½”ë“œ ì‚¬ìš©ì ì´ë¦„)ì´ ìˆì„ ê²½ìš° ëŸ°íƒ€ì„ ì—ëŸ¬ê°€ ë°œìƒí•©ë‹ˆë‹¤.

í˜„ì¬ ì‚¬ìš©ì²˜ì—ì„œëŠ” ASCII ì „ìš© ê°’ë§Œ ì „ë‹¬ë˜ì§€ë§Œ, ê³µê°œ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ì´ë¯€ë¡œ `TextEncoder` ê¸°ë°˜ ì¸ì½”ë”©ì´ ì•ˆì „í•©ë‹ˆë‹¤.


<details>
<summary>ğŸ›¡ï¸ UTF-8 ì•ˆì „ ì¸ì½”ë”© ì œì•ˆ</summary>

```diff
 function base64URLEncodeString(data: string): string {
-  return btoa(data).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
+  const bytes = new TextEncoder().encode(data);
+  return base64URLEncode(bytes);
 }
```
</details>

<!-- suggestion_start -->

<details>
<summary>ğŸ“ Committable suggestion</summary>

> â€¼ï¸ **IMPORTANT**
> Carefully review the code before committing. Ensure that it accurately replaces the highlighted code, contains no missing lines, and has no issues with indentation. Thoroughly test & benchmark the code to ensure it meets the requirements.

```suggestion
function base64URLEncodeString(data: string): string {
  const bytes = new TextEncoder().encode(data);
  return base64URLEncode(bytes);
}
```

</details>

<!-- suggestion_end -->

<details>
<summary>ğŸ¤– Prompt for AI Agents</summary>

```
Verify each finding against the current code and only fix it if needed.

In `@workers/tools/sources/jwt.ts` around lines 16 - 18, The current
base64URLEncodeString uses btoa(data) which throws on non-Latin-1 characters;
change base64URLEncodeString to first UTF-8 encode the input using TextEncoder
(e.g., new TextEncoder().encode(data)), convert the resulting Uint8Array into a
binary string of bytes (via String.fromCharCode for each byte), call btoa on
that binary string, then apply the existing URL-safe replacements; update any
callers such as signJWT to keep using base64URLEncodeString without changes.
```

</details>

<!-- fingerprinting:phantom:medusa:phoenix -->

<!-- This is an auto-generated comment by CodeRabbit -->
